pipeline {
    agent any

    environment {
        NODE_VERSION = '18'
//        SONAR_PROJECT_KEY = 'angular-php-app'
        DOCKER_COMPOSE_FILE = 'docker-compose.yml'
    }

    stages {

        stage('Checkout Code') {
            steps {
                git branch: 'main',
                    url: 'https://github.com/your-username/php-angular-mysql-docker.git'
            }
        }

        stage('Angular Build & Test') {
            steps {
                dir('angular') {
                    sh '''
                      npm install
                      npm run build --prod
                      npm test -- --watch=false --browsers=ChromeHeadless
                    '''
                }
            }
        }

        stage('PHP Syntax Check') {
            steps {
                dir('php') {
                    sh '''
                      php -l index.php
                    '''
                }
            }
        }

        stage('Static Code Analysis - SonarQube') {
            steps {
                withSonarQubeEnv('SonarQube-Server') {
                    sh '''
                      sonar-scanner \
                      -Dsonar.projectKey=$SONAR_PROJECT_KEY \
                      -Dsonar.sources=. \
                      -Dsonar.language=js,php
                    '''
                }
            }
        }

        stage('Quality Gate') {
            steps {
                timeout(time: 2, unit: 'MINUTES') {
                    waitForQualityGate abortPipeline: true
                }
            }
        }

        stage('Docker Build') {
            steps {
                sh '''
                  docker compose -f $DOCKER_COMPOSE_FILE build
                '''
            }
        }

        stage('Deploy Containers') {
            steps {
                sh '''
                  docker compose -f $DOCKER_COMPOSE_FILE down
                  docker compose -f $DOCKER_COMPOSE_FILE up -d
                '''
            }
        }
    }

    post {
        success {
            echo 'Deployment successful üöÄ'
        }
        failure {
            echo 'Pipeline failed ‚ùå'
        }
    }
}
